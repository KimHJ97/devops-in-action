# 작업 템플릿 사용하기

플레이북에 정의된 작업들을 실행하기 위해서는 어떤 호스트에서 실행할 것인지, 해당 호스트에 접근하기 위해 어떤 인증 정보를 사용할 것인지, 플레이북은 어디서 가져오고 어떤 플레이북을 실행할 것인지 등에 대한 정보가 필요하다. 그리고 이런 정보들을 정의해놓은 것이 작업 템플릿이다.

## 1. 작업 템플릿 생성 및 실행하기

 - __템플릿 생성__
    - Web UI > 리소스 > 템플릿> 추가 > 작업 템플릿 추가
    - 작업 템플릿 이름: template_monitoring_tnode
    - 인벤토리: inventory_app
    - 프로젝트: project-app
    - 플레이북: monitoring_facts.yml
    - 인증 정보: credential_tnode
    - 권한 에스컬레이션 사용 여부: 사용

## 2. 작업 템플릿 고급 기능 활용하기

사용자로부터 변수를 입력받아야 하는 경우 설문 조사를 활용할 수 있으며, 특정 작업이 끝나면 담당자에게 결과를 알려주는 알림 기능도 사용할 수 있다. 또한 주기적으로 수행해야 하는 모니터링 같은 작업들을 스케줄링하여 자동으로 실행되게 할 수도 있다.

### 2-1. 외부 변수를 입력받기 위한 설문 조사 생성하기

 - __정의하기__
    - Web UI > 리소스 > 템플릿 > 세부 화면 > 설문 조사 > 추가
    - 설문 조사를 추가할 템플릿: template_monitoring_tnode
    - 추가할 설문 조사 질문: "로그를 저장할 디렉토리 경로를 입력하세요."
    - 추가할 응답받을 변수: log_directory
    - 응답 유형: 텍스트
    - 기본 응답 값: /var/log/daily_check

### 2-2. 작업 완료를 알리기 위한 알림 기능 생성하기

자동화를 수행하면 언제 어떤 작업이 수행되었는지 사용자에게 알려주어야 하는 경우가 종종 발생한다. 알림 기능은 메일, 슬랙, 인터넷 릴레이 챗, 웹훅, 그라파나, 힙챗 등과 연동할 수 있다.

 - __알림 템플릿 생성하기__
    - 슬랙을 이용해 알림 기능을 사용하려면 운영 중인 슬랙 스페이스에 접근하기 위한 인증 토큰을 발급받아야 한다.
        - Slack 토큰 발급 가이드: https://github.com/kasunkv/slack-notification/blob/master/generate-slack-token.md
    - `Web UI > 관리 > 알림 > 추가`
        - 이름: notify_slack
        - 유형: Slack
        - 대상 채널: 채널 및 토큰 입력
 - __작업 템플릿에 알림 기능 추가하기__
    - `Web UI > 리소스 > 템플릿 > 상세 화면 > 알림`
        - 성공시 알림 활성화

### 2-3. 정기적 작업을 위한 일정 생성하기

정기적으로 동일한 업무를 수행해야 하는 작업에는 주로 크론탭에 작업을 수행하는 애플리케이션이나 셸 스크립트를 등록한다. 앤서블에서는 이러나 템플릿을 정기적으로 수행할 수 있도록 일정을 생성하는 기능을 제공한다.

 - `Web UI > 리소스 > 템플릿> 상세 화면 > 일정 > 추가`
    - 일정 이름: schedule_monitoring
    - 설명: 매일 5시에 시스템 자원 모니터링 수행
    - 작업 시작 날짜 및 시간: 시작 일자 선택
    - 반복 주기: 매일
    - 작업 종료 날짜 및 시간: 종료 일자 선택

### 2-4. 로컬 디렉토리를 이용한 작업 템플릿 생성하기

깃허브나 깃랩 같은 저장소를 사용할 수 없는 경우 임시로 앤서블 오토메이션 플랫폼이 설치된 서버의 로컬 디렉토리에 플레이북을 작성하고 작업 템플릿을 생성하여 테스트한다.

```bash
# 소유권을 aws로 변경
chown -R awx:awx /var/lib/awx/projects/example/
```

 - `Web UI > 리소스 > 프로젝트 > 추가`
    - 이름: project_local
    - 소스 제어 유형: 수동
    - 프로젝트 기본 경로: /var/lib/projects
    - 플레이북 디렉토리: example
 - `Web UI > 리소스 > 템플릿 > 추가 > 작업 템플릿 추가`
    - 이름: template_monitoring_system
    - 인벤토리: inventory_app
    - 프로젝트: project_local
    - Playbook: monitoring_system.yml
    - 옵션: 권한 에스컬레이션
